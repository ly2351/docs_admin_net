"use strict";(self.webpackChunkdocs_admin_net=self.webpackChunkdocs_admin_net||[]).push([[3866],{177:(n,e,o)=>{o.r(e),o.d(e,{assets:()=>g,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"backend/log","title":"22. \u65e5\u5fd7\u8bb0\u5f55","description":"Admin.NET \u5df2\u5b9e\u73b0\u5305\u62ec\u884c\u4e3a\u65e5\u5fd7\u3001\u5f02\u5e38\u65e5\u5fd7\u3001\u5ba1\u8ba1\u65e5\u5fd7\u3001\u8bbf\u95ee\u65e5\u5fd7\u7b49\u529f\u80fd\u3002\u65e5\u5fd7\u91c7\u7528 Furion \u81ea\u5e26\u7684\u65e5\u5fd7\u7ec4\u4ef6\uff0c\u7b80\u5355\u65b9\u4fbf\u3002.NET \u672c\u8eab\u81ea\u5e26\u7684\u5185\u7f6e\u65e5\u5fd7\u7ec4\u4ef6ILogger \u4e5f\u5f88\u597d\uff0c\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u4e0d\u540c\u7684\u8bb0\u5f55\u63d0\u4f9b\u7a0b\u5e8f\u5c06\u65e5\u5fd7\u5199\u5165\u4e0d\u540c\u7684\u76ee\u6807\u3002 \u57fa\u672c\u65e5\u5fd7\u8bb0\u5f55\u63d0\u4f9b\u7a0b\u5e8f\u662f\u5185\u7f6e\u7684\uff0c\u5e76\u4e14\u8fd8\u53ef\u4ee5\u4f7f\u7528\u8bb8\u591a\u7b2c\u4e09\u65b9\u63d0\u4f9b\u7a0b\u5e8f\uff0c\u6bd4\u5982 log4net\u3002","source":"@site/docs/backend/log.md","sourceDirName":"backend","slug":"/backend/log","permalink":"/docs_admin_net/docs/backend/log","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/backend/log.md","tags":[],"version":"current","sidebarPosition":22,"frontMatter":{"sidebar_position":22},"sidebar":"tutorialSidebar","previous":{"title":"21. \u4ee4\u724cToken","permalink":"/docs_admin_net/docs/backend/token"},"next":{"title":"23. \u4ee3\u7801\u751f\u6210","permalink":"/docs_admin_net/docs/backend/codegen"}}');var r=o(3420),i=o(5404);const s={sidebar_position:22},a="22. \u65e5\u5fd7\u8bb0\u5f55",g={},l=[];function c(n){const e={a:"a",admonition:"admonition",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,i.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"22-\u65e5\u5fd7\u8bb0\u5f55",children:"22. \u65e5\u5fd7\u8bb0\u5f55"})}),"\n",(0,r.jsx)(e.admonition,{title:"\u63d0\u793a",type:"tip",children:(0,r.jsxs)(e.p,{children:["Admin.NET \u5df2\u5b9e\u73b0\u5305\u62ec\u884c\u4e3a\u65e5\u5fd7\u3001\u5f02\u5e38\u65e5\u5fd7\u3001\u5ba1\u8ba1\u65e5\u5fd7\u3001\u8bbf\u95ee\u65e5\u5fd7\u7b49\u529f\u80fd\u3002\u65e5\u5fd7\u91c7\u7528 ",(0,r.jsx)(e.code,{children:"Furion"})," \u81ea\u5e26\u7684\u65e5\u5fd7\u7ec4\u4ef6\uff0c\u7b80\u5355\u65b9\u4fbf\u3002.NET \u672c\u8eab\u81ea\u5e26\u7684\u5185\u7f6e\u65e5\u5fd7\u7ec4\u4ef6",(0,r.jsx)(e.a,{href:"https://learn.microsoft.com/zh-cn/dotnet/core/extensions/logging?tabs=command-line",children:"ILogger"})," \u4e5f\u5f88\u597d\uff0c\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u4e0d\u540c\u7684\u8bb0\u5f55\u63d0\u4f9b\u7a0b\u5e8f\u5c06\u65e5\u5fd7\u5199\u5165\u4e0d\u540c\u7684\u76ee\u6807\u3002 \u57fa\u672c\u65e5\u5fd7\u8bb0\u5f55\u63d0\u4f9b\u7a0b\u5e8f\u662f\u5185\u7f6e\u7684\uff0c\u5e76\u4e14\u8fd8\u53ef\u4ee5\u4f7f\u7528\u8bb8\u591a\u7b2c\u4e09\u65b9\u63d0\u4f9b\u7a0b\u5e8f\uff0c\u6bd4\u5982 log4net\u3002"]})}),"\n",(0,r.jsxs)(e.p,{children:["\u76ee\u524d\u65e5\u5fd7\u5b58\u50a8\u652f\u6301\u6570\u636e\u5e93\u5b58\u50a8\u3001\u6587\u4ef6\u5b58\u50a8\u3001ElasticSearch\uff0c\u914d\u7f6e\u6587\u4ef6 ",(0,r.jsx)(e.a,{href:"https://gitee.com/zuohuaijun/Admin.NET/blob/next/Admin.NET/Admin.NET.Application/Configuration/Logging.json",children:"/Configuration/Logging.json"}),"\u3002\u5176\u4e2d Monitor.GlobalEnabled \u53ef\u4ee5\u914d\u7f6e\u5168\u5c40\u662f\u5426\u542f\u52a8\u65e5\u5fd7\uff08\u5982\u82e5\u4e0d\u9700\u8981\u8bb0\u5f55\u65e5\u5fd7\uff0c\u53ef\u4ee5\u5173\u95ed\u6b64\u9879\u914d\u7f6e\uff09\u3002"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-json",children:'{\n  "$schema": "https://gitee.com/dotnetchina/Furion/raw/v4/schemas/v4/furion-schema.json",\n\n  "Logging": {\n    "LogLevel": {\n      "Default": "Information",\n      "Microsoft.AspNetCore": "Warning",\n      "Microsoft.EntityFrameworkCore": "Information"\n    },\n    "File": {\n      "Enabled": false, // \u542f\u7528\u6587\u4ef6\u65e5\u5fd7\n      "FileName": "logs/{0:yyyyMMdd}_{1}.log", // \u65e5\u5fd7\u6587\u4ef6\n      "Append": true, // \u8ffd\u52a0\u8986\u76d6\n      // "MinimumLevel": "Information", // \u65e5\u5fd7\u7ea7\u522b\n      "FileSizeLimitBytes": 10485760, // 10M=10*1024*1024\n      "MaxRollingFiles": 30 // \u53ea\u4fdd\u755930\u4e2a\u6587\u4ef6\n    },\n    "Database": {\n      "Enabled": true, // \u542f\u7528\u6570\u636e\u5e93\u65e5\u5fd7\n      "MinimumLevel": "Information"\n    },\n    "ElasticSearch": {\n      "Enabled": false, // \u542f\u7528ES\u65e5\u5fd7\n      "AuthType": "Basic", // ES\u8ba4\u8bc1\u7c7b\u578b\uff0c\u53ef\u9009 Basic\u3001ApiKey\u3001Base64ApiKey\n      "User": "admin", // Basic\u8ba4\u8bc1\u7684\u7528\u6237\u540d\uff0c\u4f7f\u7528Basic\u8ba4\u8bc1\u7c7b\u578b\u65f6\u5fc5\u586b\n      "Password": "123456", // Basic\u8ba4\u8bc1\u7684\u5bc6\u7801\uff0c\u4f7f\u7528Basic\u8ba4\u8bc1\u7c7b\u578b\u65f6\u5fc5\u586b\n      "ApiId": "", // \u4f7f\u7528ApiKey\u8ba4\u8bc1\u7c7b\u578b\u65f6\u5fc5\u586b\n      "ApiKey": "", // \u4f7f\u7528ApiKey\u8ba4\u8bc1\u7c7b\u578b\u65f6\u5fc5\u586b\n      "Base64ApiKey": "TmtrOEszNEJuQ0NyaWlydGtROFk6SG1RZ0w3YzBTc2lCanJTYlV3aXNzZw==", // \u4f7f\u7528Base64ApiKey\u8ba4\u8bc1\u7c7b\u578b\u65f6\u5fc5\u586b\n      "Fingerprint": "37:08:6A:C6:06:CC:9A:43:CF:ED:25:A2:1C:A4:69:57:90:31:2C:06:CA:61:56:39:6A:9C:46:11:BD:22:51:DA", // ES\u4f7f\u7528Https\u65f6\u7684\u8bc1\u4e66\u6307\u7eb9\n      "ServerUris": [ "http://192.168.1.100:9200" ], // \u5730\u5740\n      "DefaultIndex": "adminnet" // \u7d22\u5f15\n    },\n    "Monitor": {\n      "GlobalEnabled": true, // \u542f\u7528\u5168\u5c40\u62e6\u622a\u65e5\u5fd7\n      "IncludeOfMethods": [], // \u62e6\u622a\u7279\u5b9a\u65b9\u6cd5\uff0c\u5f53GlobalEnabled=false\u6709\u6548\n      "ExcludeOfMethods": [], // \u6392\u9664\u7279\u5b9a\u65b9\u6cd5\uff0c\u5f53GlobalEnabled=true\u6709\u6548\n      "BahLogLevel": "Information", // Oops.Oh \u548c Oops.Bah \u4e1a\u52a1\u65e5\u5fd7\u8f93\u51fa\u7ea7\u522b\n      "WithReturnValue": true, // \u662f\u5426\u5305\u542b\u8fd4\u56de\u503c\uff0c\u9ed8\u8ba4true\n      "ReturnValueThreshold": 500, // \u8fd4\u56de\u503c\u5b57\u7b26\u4e32\u9608\u503c\uff0c\u9ed8\u8ba40\u5168\u91cf\u8f93\u51fa\n      "JsonBehavior": "None", // \u662f\u5426\u8f93\u51faJson\uff0c\u9ed8\u8ba4None(OnlyJson\u3001All)\n      "JsonIndented": false, // \u662f\u5426\u683c\u5f0f\u5316Json\n      "UseUtcTimestamp": false, // \u65f6\u95f4\u683c\u5f0fUTC\u3001LOCAL\n      "ConsoleLog": true // \u662f\u5426\u663e\u793a\u63a7\u5236\u53f0\u65e5\u5fd7\n    }\n  }\n}\n'})}),"\n",(0,r.jsxs)(e.p,{children:["\u7cfb\u7edf\u96c6\u6210\u5b9e\u73b0\u7c7b ",(0,r.jsx)(e.a,{href:"https://gitee.com/zuohuaijun/Admin.NET/blob/next/Admin.NET/Admin.NET.Core/Logging/LoggingSetup.cs",children:"Admin.NET.Core/Logging/LoggingSetup.cs"})," \u4f9b\u5176\u53c2\u8003\uff0c\u90fd\u5df2\u7ecf\u81ea\u52a8\u5316\uff0c\u53ea\u9700\u8981\u6539\u6539\u914d\u7f6e\u6587\u4ef6\u5373\u53ef\uff0c\u65e0\u9700\u5199\u989d\u5916\u7684\u4ee3\u7801\u903b\u8f91\u5b9e\u73b0\u3002"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-csharp",children:'namespace Admin.NET.Core;\n\npublic static class LoggingSetup\n{\n    /// <summary>\n    /// \u65e5\u5fd7\u6ce8\u518c\n    /// </summary>\n    /// <param name="services"></param>\n    public static void AddLoggingSetup(this IServiceCollection services)\n    {\n        // \u65e5\u5fd7\u76d1\u542c\n        services.AddMonitorLogging(options =>\n        {\n            options.IgnorePropertyNames = new[] { "Byte" };\n            options.IgnorePropertyTypes = new[] { typeof(byte[]) };\n        });\n\n        // \u63a7\u5236\u53f0\u65e5\u5fd7\n        var consoleLog = App.GetConfig<bool>("Logging:Monitor:ConsoleLog", true);\n        services.AddConsoleFormatter(options =>\n        {\n            options.DateFormat = "yyyy-MM-dd HH:mm:ss(zzz) dddd";\n            //options.WithTraceId = true; // \u663e\u793a\u7ebf\u7a0bId\n            //options.WithStackFrame = true; // \u663e\u793a\u7a0b\u5e8f\u96c6\n            options.WriteFilter = (logMsg) =>\n            {\n                return consoleLog;\n            };\n        });\n\n        // \u65e5\u5fd7\u5199\u5165\u6587\u4ef6\n        if (App.GetConfig<bool>("Logging:File:Enabled", true))\n        {\n            var loggingMonitorSettings = App.GetConfig<LoggingMonitorSettings>("Logging:Monitor", true);\n            Array.ForEach(new[] { LogLevel.Information, LogLevel.Warning, LogLevel.Error }, logLevel =>\n            {\n                services.AddFileLogging(options =>\n                {\n                    options.WithTraceId = true; // \u663e\u793a\u7ebf\u7a0bId\n                    options.WithStackFrame = true; // \u663e\u793a\u7a0b\u5e8f\u96c6\n                    options.FileNameRule = fileName => string.Format(fileName, DateTime.Now, logLevel.ToString()); // \u6bcf\u5929\u521b\u5efa\u4e00\u4e2a\u6587\u4ef6\n                    options.WriteFilter = logMsg => logMsg.LogLevel == logLevel; // \u65e5\u5fd7\u7ea7\u522b\n                    options.HandleWriteError = (writeError) => // \u5199\u5165\u5931\u8d25\u65f6\u542f\u7528\u5907\u7528\u6587\u4ef6\n                    {\n                        writeError.UseRollbackFileName(Path.GetFileNameWithoutExtension(writeError.CurrentFileName) + "-oops" + Path.GetExtension(writeError.CurrentFileName));\n                    };\n                    if (loggingMonitorSettings.JsonBehavior == JsonBehavior.OnlyJson)\n                    {\n                        options.MessageFormat = LoggerFormatter.Json;\n                        // options.MessageFormat = LoggerFormatter.JsonIndented;\n                        options.MessageFormat = (logMsg) =>\n                        {\n                            var jsonString = logMsg.Context.Get("loggingMonitor");\n                            return jsonString?.ToString();\n                        };\n                    }\n                });\n            });\n        }\n\n        // \u65e5\u5fd7\u5199\u5165ElasticSearch\n        if (App.GetConfig<bool>("Logging:ElasticSearch:Enabled", true))\n        {\n            services.AddDatabaseLogging<ElasticSearchLoggingWriter>(options =>\n            {\n                options.WithTraceId = true; // \u663e\u793a\u7ebf\u7a0bId\n                options.WithStackFrame = true; // \u663e\u793a\u7a0b\u5e8f\u96c6\n                options.IgnoreReferenceLoop = false; // \u5ffd\u7565\u5faa\u73af\u68c0\u6d4b\n                options.MessageFormat = LoggerFormatter.Json;\n                options.WriteFilter = (logMsg) =>\n                {\n                    return logMsg.LogName == CommonConst.SysLogCategoryName; // \u53ea\u5199LoggingMonitor\u65e5\u5fd7\n                };\n            });\n        }\n\n        // \u65e5\u5fd7\u5199\u5165\u6570\u636e\u5e93\n        if (App.GetConfig<bool>("Logging:Database:Enabled", true))\n        {\n            services.AddDatabaseLogging<DatabaseLoggingWriter>(options =>\n            {\n                options.WithTraceId = true; // \u663e\u793a\u7ebf\u7a0bId\n                options.WithStackFrame = true; // \u663e\u793a\u7a0b\u5e8f\u96c6\n                options.IgnoreReferenceLoop = false; // \u5ffd\u7565\u5faa\u73af\u68c0\u6d4b\n                options.WriteFilter = (logMsg) =>\n                {\n                    return logMsg.LogName == CommonConst.SysLogCategoryName; // \u53ea\u5199LoggingMonitor\u65e5\u5fd7\n                };\n            });\n        }\n    }\n}\n'})}),"\n",(0,r.jsxs)(e.p,{children:["1\u3001\u6cdb\u578b\u65b9\u5f0f\uff1a\u901a\u8fc7\u6ce8\u5165 ",(0,r.jsx)(e.code,{children:"ILogger<T>"})," \u5bf9\u8c61\u8fdb\u884c\u64cd\u4f5c\u65e5\u5fd7\uff0c\u5982"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-csharp",children:'public class xxxTest\n{\n    private readonly ILogger<xxxTest> _logger;\n\n    public xxxTest(ILogger<xxxTest> logger)\n    {\n        _logger = logger;\n    }\n\n    public void Test()\n    {\n        _logger.LogInformation("\u65e5\u5fd7\u5185\u5bb9\u3002\u3002\u3002");\n    }\n}\n'})}),"\n",(0,r.jsxs)(e.p,{children:["2\u3001\u5de5\u5382\u65b9\u5f0f\uff1a",(0,r.jsx)(e.code,{children:"ILoggerFactory"})," \u5de5\u5382\u65b9\u5f0f"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-csharp",children:'public class xxxTest\n{\n    private readonly ILogger _logger;\n\n    public xxxTest(ILoggerFactory logger)\n    {\n        _logger = logger.CreateLogger("\u6211\u7684\u5206\u7ec4");\n    }\n\n    public void Test()\n    {\n        _logger.LogInformation("\u65e5\u5fd7\u5185\u5bb9\u3002\u3002\u3002");\n    }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"3\u3001\u9759\u6001\u65b9\u5f0f\uff1aLog \u9759\u6001\u7c7b\u65b9\u5f0f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-csharp",children:'// \u521b\u5efa\u65e5\u5fd7\u5bf9\u8c61\nvar logger = Log.CreateLogger("\u65e5\u5fd7\u540d\u79f0");\n\n// \u521b\u5efa\u65e5\u5fd7\u5de5\u5382\nusing var loggerFactory = Log.CreateLoggerFactory(builder => {\n\n});\n\n// \u65e5\u5fd7\u8bb0\u5f55\nLog.Information("xxx");\nLog.Warning("xxx");\nLog.Error("xxx");\nLog.Debug("xxx");\nLog.Trace("xxx");\nLog.Critical("xxx");\n'})}),"\n",(0,r.jsx)(e.p,{children:"4\u3001\u5b57\u7b26\u4e32\u62d3\u5c55\u7684\u65b9\u5f0f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-csharp",children:'"xxx".LogInformation();\n\n"xxx".LogError<xxxController>();\n\n"xxx".SetCategory<xxxController>().LogInformation();\n'})}),"\n",(0,r.jsx)(e.admonition,{title:"\u63d0\u793a",type:"tip",children:(0,r.jsxs)(e.p,{children:["\u5185\u7f6e\u4e86\u65e5\u5fd7\u5206\u7ec4\u5e38\u91cf ",(0,r.jsx)(e.code,{children:"CommonConst.SysLogCategoryName"}),"\uff0c\u5728\u9700\u8981\u81ea\u5b9a\u4e49\u65e5\u5fd7\u4e14\u4e0e\u7cfb\u7edf\u5339\u914d\u8d77\u6765\u81ea\u52a8\u5b58\u50a8\u65f6\uff0c",(0,r.jsx)(e.code,{children:"_logger = loggerFactory.CreateLogger(CommonConst.SysLogCategoryName);"})," \u8fd9\u65f6\u81ea\u5b9a\u4e49\u7684\u65e5\u5fd7\u5c31\u4f1a\u81ea\u52a8\u5b58\u50a8\u3002"]})}),"\n",(0,r.jsx)(e.p,{children:"\u4e0b\u9762\u65f6\u81ea\u5b9a\u4e49\u65e5\u5fd7\u5b58\u50a8\u7684\u5b9e\u73b0\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-csharp",children:'    public async Task WriteAsync(LogMessage logMsg, bool flush)\n    {\n        var jsonStr = logMsg.Context?.Get("loggingMonitor")?.ToString();\n        if (string.IsNullOrWhiteSpace(jsonStr))\n        {\n            await _db.Insertable(new SysLogOp\n            {\n                DisplayTitle = "\u81ea\u5b9a\u4e49\u64cd\u4f5c\u65e5\u5fd7",\n                LogDateTime = logMsg.LogDateTime,\n                EventId = logMsg.EventId.Id,\n                ThreadId = logMsg.ThreadId,\n                TraceId = logMsg.TraceId,\n                Exception = logMsg.Exception == null ? null : JSON.Serialize(logMsg.Exception),\n                Message = logMsg.Message,\n                LogLevel = logMsg.LogLevel,\n                Status = "200",\n            }).ExecuteCommandAsync();\n            return;\n        }\n    }\n'})})]})}function d(n={}){const{wrapper:e}={...(0,i.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(c,{...n})}):c(n)}},5404:(n,e,o)=>{o.d(e,{R:()=>s,x:()=>a});var t=o(6672);const r={},i=t.createContext(r);function s(n){const e=t.useContext(i);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:s(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);