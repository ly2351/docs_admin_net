"use strict";(self.webpackChunkdocs_admin_net=self.webpackChunkdocs_admin_net||[]).push([[9914],{3218:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>u});const r=JSON.parse('{"id":"backend/oauth","title":"11. \u7edf\u4e00\u8ba4\u8bc1","description":"Admin.NET \u7b2c\u4e09\u65b9\u6388\u6743\u767b\u5f55\u91c7\u7528\u7ec4\u4ef6 AspNet.Security.OAuth.Providers\u3002\u7cfb\u7edf\u5df2\u7ecf\u7ee7\u627f AspNet.Security.OAuth.Gitee\u3001AspNet.Security.OAuth.Weixin\uff0c\u5176\u4ed6\u4e09\u65b9\u53ef\u81ea\u884c\u6dfb\u52a0\u3002\u5177\u4f53\u4f7f\u7528\u6d41\u7a0b\u53ef\u53c2\u8003\u6559\u7a0b GitHub\u7b2c\u4e09\u65b9\u6388\u6743\u767b\u5f55","source":"@site/docs/backend/oauth.md","sourceDirName":"backend","slug":"/backend/oauth","permalink":"/docs_admin_net/docs/backend/oauth","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/backend/oauth.md","tags":[],"version":"current","sidebarPosition":11,"frontMatter":{"sidebar_position":11},"sidebar":"tutorialSidebar","previous":{"title":"10. \u5373\u65f6\u901a\u8baf","permalink":"/docs_admin_net/docs/backend/im"},"next":{"title":"12. \u63a5\u53e3\u9650\u6d41","permalink":"/docs_admin_net/docs/backend/limit"}}');var i=t(3420),s=t(5404);const a={sidebar_position:11},o="11. \u7edf\u4e00\u8ba4\u8bc1",c={},u=[];function l(e){const n={admonition:"admonition",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"11-\u7edf\u4e00\u8ba4\u8bc1",children:"11. \u7edf\u4e00\u8ba4\u8bc1"})}),"\n",(0,i.jsx)(n.admonition,{title:"\u63d0\u793a",type:"tip",children:(0,i.jsxs)(n.p,{children:["Admin.NET \u7b2c\u4e09\u65b9\u6388\u6743\u767b\u5f55\u91c7\u7528\u7ec4\u4ef6 ",(0,i.jsx)(n.code,{children:"AspNet.Security.OAuth.Providers"}),"\u3002\u7cfb\u7edf\u5df2\u7ecf\u7ee7\u627f ",(0,i.jsx)(n.code,{children:"AspNet.Security.OAuth.Gitee"}),"\u3001",(0,i.jsx)(n.code,{children:"AspNet.Security.OAuth.Weixin"}),"\uff0c\u5176\u4ed6\u4e09\u65b9\u53ef\u81ea\u884c\u6dfb\u52a0\u3002\u5177\u4f53\u4f7f\u7528\u6d41\u7a0b\u53ef\u53c2\u8003\u6559\u7a0b GitHub\u7b2c\u4e09\u65b9\u6388\u6743\u767b\u5f55"]})}),"\n",(0,i.jsxs)(n.p,{children:["\u914d\u7f6e\u6587\u4ef6 OAuth.json\uff0c\u6bcf\u4e2a\u5e73\u53f0\u7684 ",(0,i.jsx)(n.code,{children:"ClientId"}),"\u3001",(0,i.jsx)(n.code,{children:"ClientSecret"}),"\u8bf7\u81ea\u884c\u586b\u5199\uff0c\u5e76\u6839\u636e\u90e8\u7f72\u5730\u5740\uff0c\u586b\u5199\u6307\u5b9a\u7684\u767b\u5f55\u56de\u8c03\u5730\u5740\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "$schema": "https://gitee.com/dotnetchina/Furion/raw/v4/schemas/v4/furion-schema.json",\n\n  "OAuth": {\n    "Weixin": {\n      "ClientId": "xxx",\n      "ClientSecret": "xxx"\n    },\n    "Gitee": {\n      "ClientId": "xxx",\n      "ClientSecret": "xxx"\n    }\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u7edf\u4e00\u6388\u6743\u7b2c\u4e09\u65b9\u767b\u5f55\u7684\u65f6\u5019\uff0c\u5728\u767b\u5f55\u56de\u8c03\u5730\u5740\u91cc\u9762\u5904\u7406\u767b\u5f55\u6743\u9650\u903b\u8f91\u3002\u7cfb\u7edf\u4f1a\u81ea\u52a8\u521b\u5efa\u8d26\u53f7\u53ca\u9ed8\u8ba4\u5206\u914d\u89d2\u8272\u6743\u9650\uff0c\u7cfb\u7edf\u8868 ",(0,i.jsx)(n.code,{children:"SysOAuthUser"})," \u5b58\u50a8\u4e09\u65b9\u8d26\u53f7\u76f8\u5173\uff0c\u7cfb\u7edf\u8d26\u53f7\u8868 ",(0,i.jsx)(n.code,{children:"SysUser"})," \u5219\u4fdd\u5b58\u5176\u5bf9\u5e94\u7cfb\u7edf\u8d26\u53f7\u4fe1\u606f\u3002\u82e5\u5df2\u5b58\u5728\u5219\u76f4\u63a5\u8fdb\u884c\u7cfb\u7edf\u767b\u5f55\u3002\u5177\u4f53\u5b9e\u73b0\u7c7b\u89c1 ",(0,i.jsx)(n.code,{children:"SysOAuthService.cs"})," \uff0c\u6b64\u65f6\u524d\u7aef\u767b\u5f55\u4f1a\u6839\u636e ",(0,i.jsx)(n.code,{children:"/login?token={token.AccessToken}"})," \u8fdb\u884c\u8def\u7531\u53c2\u6570\u89e3\u6790 Token\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-csharp",children:'using Microsoft.AspNetCore.Authentication;\nusing System.Security.Claims;\n\nnamespace Admin.NET.Core.Service;\n\n/// <summary>\n/// \u7cfb\u7edfOAuth\u670d\u52a1 \ud83e\udde9\n/// </summary>\n[AllowAnonymous]\n[ApiDescriptionSettings(Order = 498)]\npublic class SysOAuthService : IDynamicApiController, ITransient\n{\n    private readonly IHttpContextAccessor _httpContextAccessor;\n    private readonly SqlSugarRepository<SysOAuthUser> _sysOAuthUserRep;\n\n    public SysOAuthService(IHttpContextAccessor httpContextAccessor,\n        SqlSugarRepository<SysOAuthUser> sysOAuthUserRep)\n    {\n        _httpContextAccessor = httpContextAccessor;\n        _sysOAuthUserRep = sysOAuthUserRep;\n    }\n\n    /// <summary>\n    /// \u7b2c\u4e09\u65b9\u767b\u5f55 \ud83d\udd16\n    /// </summary>\n    /// <param name="provider"></param>\n    /// <param name="redirectUrl"></param>\n    /// <returns></returns>\n    [ApiDescriptionSettings(Name = "SignIn"), HttpGet]\n    [DisplayName("\u7b2c\u4e09\u65b9\u767b\u5f55")]\n    public virtual async Task<IActionResult> SignIn([FromQuery] string provider, [FromQuery] string redirectUrl)\n    {\n        if (string.IsNullOrWhiteSpace(provider) || !await _httpContextAccessor.HttpContext.IsProviderSupportedAsync(provider))\n            throw Oops.Oh("\u4e0d\u652f\u6301\u7684OAuth\u7c7b\u578b");\n\n        var request = _httpContextAccessor.HttpContext.Request;\n        var url = $"{request.Scheme}://{request.Host}{request.PathBase}{request.Path}Callback?provider={provider}&redirectUrl={redirectUrl}";\n        var properties = new AuthenticationProperties { RedirectUri = url };\n        properties.Items["LoginProvider"] = provider;\n        return await Task.FromResult(new ChallengeResult(provider, properties));\n    }\n\n    /// <summary>\n    /// \u6388\u6743\u56de\u8c03 \ud83d\udd16\n    /// </summary>\n    /// <param name="provider"></param>\n    /// <param name="redirectUrl"></param>\n    /// <returns></returns>\n    [ApiDescriptionSettings(Name = "SignInCallback"), HttpGet]\n    [DisplayName("\u6388\u6743\u56de\u8c03")]\n    public virtual async Task<IActionResult> SignInCallback([FromQuery] string provider = null, [FromQuery] string redirectUrl = "")\n    {\n        if (string.IsNullOrWhiteSpace(provider) || !await _httpContextAccessor.HttpContext.IsProviderSupportedAsync(provider))\n            throw Oops.Oh("\u4e0d\u652f\u6301\u7684OAuth\u7c7b\u578b");\n\n        var authenticateResult = await _httpContextAccessor.HttpContext.AuthenticateAsync(provider);\n        if (!authenticateResult.Succeeded)\n            throw Oops.Oh("\u6388\u6743\u5931\u8d25");\n\n        var openIdClaim = authenticateResult.Principal.FindFirst(ClaimTypes.NameIdentifier);\n        if (openIdClaim == null || string.IsNullOrWhiteSpace(openIdClaim.Value))\n            throw Oops.Oh("\u6388\u6743\u5931\u8d25");\n\n        var name = authenticateResult.Principal.FindFirst(ClaimTypes.Name)?.Value;\n        var email = authenticateResult.Principal.FindFirst(ClaimTypes.Email)?.Value;\n        var mobilePhone = authenticateResult.Principal.FindFirst(ClaimTypes.MobilePhone)?.Value;\n        var dateOfBirth = authenticateResult.Principal.FindFirst(ClaimTypes.DateOfBirth)?.Value;\n        var gender = authenticateResult.Principal.FindFirst(ClaimTypes.Gender)?.Value;\n        var avatarUrl = "";\n\n        var platformType = PlatformTypeEnum.\u5fae\u4fe1\u516c\u4f17\u53f7;\n        if (provider == "Gitee")\n        {\n            platformType = PlatformTypeEnum.Gitee;\n            avatarUrl = authenticateResult.Principal.FindFirst(OAuthClaim.GiteeAvatarUrl)?.Value;\n        }\n\n        // \u82e5\u8d26\u53f7\u4e0d\u5b58\u5728\u5219\u65b0\u5efa\n        var wechatUser = await _sysOAuthUserRep.AsQueryable().Includes(u => u.SysUser).ClearFilter().FirstAsync(u => u.OpenId == openIdClaim.Value);\n        if (wechatUser == null)\n        {\n            var userId = await App.GetRequiredService<SysUserService>().AddUser(new AddUserInput()\n            {\n                Account = name,\n                RealName = name,\n                NickName = name,\n                Email = email,\n                Avatar = avatarUrl,\n                Phone = mobilePhone,\n                OrgId = 1300000000101, // \u6839\u7ec4\u7ec7\u67b6\u6784\n                RoleIdList = new List<long> { 1300000000104 } // \u4ec5\u672c\u4eba\u6570\u636e\u89d2\u8272\n            });\n\n            await _sysOAuthUserRep.InsertAsync(new SysOAuthUser()\n            {\n                UserId = userId,\n                OpenId = openIdClaim.Value,\n                Avatar = avatarUrl,\n                NickName = name,\n                PlatformType = platformType\n            });\n\n            wechatUser = await _sysOAuthUserRep.AsQueryable().Includes(u => u.SysUser).ClearFilter().FirstAsync(u => u.OpenId == openIdClaim.Value);\n        }\n\n        // \u6784\u5efaToken\u4ee4\u724c\n        var token = await App.GetRequiredService<SysAuthService>().CreateToken(wechatUser.SysUser);\n\n        return new RedirectResult($"{redirectUrl}/#/login?token={token.AccessToken}");\n    }\n}\n'})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},5404:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>o});var r=t(6672);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);