"use strict";(self.webpackChunkdocs_admin_net=self.webpackChunkdocs_admin_net||[]).push([[3951],{5404:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var r=t(6672);const i={},a=r.createContext(i);function s(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(a.Provider,{value:n},e.children)}},5972:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"backend/permission","title":"9. \u6570\u636e\u6743\u9650","description":"Admin.NET \u91c7\u7528\u5e38\u89c1\u7684RBAC\u6743\u9650\u7ba1\u7406\u6a21\u578b\uff0c\u7ed9\u89d2\u8272\u5206\u914d\u83dc\u5355\u3001\u6309\u94ae\u53ca\u63a5\u53e3\u8d44\u6e90\u6743\u9650\uff0c\u7136\u540e\u7ed9\u7528\u6237\u6307\u5b9a\u76f8\u5e94\u89d2\u8272\uff0c\u652f\u6301\u591a\u89d2\u8272\u6a21\u5f0f\u3002\u6709\u6570\u636e\u884c\u6743\u9650\u9700\u6c42\u65f6\uff0c\u8be5\u5b9e\u4f53/\u8868\u5fc5\u987b\u7ee7\u627f\u6b64\u57fa\u7c7b\uff0c\u6bd4\u5982\u6570\u636e\u5206\u90e8\u95e8\u3001\u5206\u4e0a\u4e0b\u7ea7\u7b49\u3002\u7cfb\u7edf\u81ea\u52a8\u8d4b\u503c\u5f53\u524d\u64cd\u4f5c\u8005\u90e8\u95e8Id\u3001\u90e8\u95e8\u540d\u79f0\uff0c\u5e94\u7528\u5c42\u65e0\u9700\u624b\u52a8\u5904\u7406\u3002","source":"@site/docs/backend/permission.md","sourceDirName":"backend","slug":"/backend/permission","permalink":"/docs_admin_net/docs/backend/permission","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/backend/permission.md","tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"sidebar_position":9},"sidebar":"tutorialSidebar","previous":{"title":"8. \u6570\u636e\u5e93\u914d\u7f6e","permalink":"/docs_admin_net/docs/backend/dbconfig"},"next":{"title":"10. \u5373\u65f6\u901a\u8baf","permalink":"/docs_admin_net/docs/backend/im"}}');var i=t(3420),a=t(5404);const s={sidebar_position:9},o="9. \u6570\u636e\u6743\u9650",l={},c=[];function d(e){const n={admonition:"admonition",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"9-\u6570\u636e\u6743\u9650",children:"9. \u6570\u636e\u6743\u9650"})}),"\n",(0,i.jsx)(n.admonition,{title:"\u63d0\u793a",type:"tip",children:(0,i.jsx)(n.p,{children:"Admin.NET \u91c7\u7528\u5e38\u89c1\u7684RBAC\u6743\u9650\u7ba1\u7406\u6a21\u578b\uff0c\u7ed9\u89d2\u8272\u5206\u914d\u83dc\u5355\u3001\u6309\u94ae\u53ca\u63a5\u53e3\u8d44\u6e90\u6743\u9650\uff0c\u7136\u540e\u7ed9\u7528\u6237\u6307\u5b9a\u76f8\u5e94\u89d2\u8272\uff0c\u652f\u6301\u591a\u89d2\u8272\u6a21\u5f0f\u3002\u6709\u6570\u636e\u884c\u6743\u9650\u9700\u6c42\u65f6\uff0c\u8be5\u5b9e\u4f53/\u8868\u5fc5\u987b\u7ee7\u627f\u6b64\u57fa\u7c7b\uff0c\u6bd4\u5982\u6570\u636e\u5206\u90e8\u95e8\u3001\u5206\u4e0a\u4e0b\u7ea7\u7b49\u3002\u7cfb\u7edf\u81ea\u52a8\u8d4b\u503c\u5f53\u524d\u64cd\u4f5c\u8005\u90e8\u95e8Id\u3001\u90e8\u95e8\u540d\u79f0\uff0c\u5e94\u7528\u5c42\u65e0\u9700\u624b\u52a8\u5904\u7406\u3002"})}),"\n",(0,i.jsx)(n.p,{children:"\u53ea\u9700\u8981\u6b63\u786e\u5b9a\u4e49\u5b9e\u4f53\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u6570\u636e\u6743\u9650\u8fc7\u6ee4\uff0c\u5c31\u8fd9\u4e48\u7b80\u5355!"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-csharp",children:'/// <summary>\n/// \u4e1a\u52a1\u6570\u636e\u5b9e\u4f53\u57fa\u7c7b\uff08\u6570\u636e\u6743\u9650\uff09\n/// </summary>\npublic abstract class EntityBaseData : EntityBase, IOrgIdFilter\n{\n    /// <summary>\n    /// \u521b\u5efa\u8005\u90e8\u95e8Id\n    /// </summary>\n    [SugarColumn(ColumnDescription = "\u521b\u5efa\u8005\u90e8\u95e8Id", IsOnlyIgnoreUpdate = true)]\n    public virtual long? CreateOrgId { get; set; }\n\n    /// <summary>\n    /// \u521b\u5efa\u8005\u90e8\u95e8\n    /// </summary>\n    [Newtonsoft.Json.JsonIgnore]\n    [System.Text.Json.Serialization.JsonIgnore]\n    [Navigate(NavigateType.OneToOne, nameof(CreateOrgId))]\n    public virtual SysOrg CreateOrg { get; set; }\n\n    /// <summary>\n    /// \u521b\u5efa\u8005\u90e8\u95e8\u540d\u79f0\n    /// </summary>\n    [SugarColumn(ColumnDescription = "\u521b\u5efa\u8005\u90e8\u95e8\u540d\u79f0", Length = 64, IsOnlyIgnoreUpdate = true)]\n    public virtual string? CreateOrgName { get; set; }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u9488\u5bf9\u7ee7\u627f\u8be5\u57fa\u7c7b\u7684\u5b9e\u4f53\uff0c\u7cfb\u7edf\u4f1a\u81ea\u52a8\u751f\u6210\u5168\u5c40\u67e5\u8be2\u62e6\u622a\uff0c\u67e5\u8be2\u7684\u65f6\u5019\u81ea\u52a8\u5c06\u5f53\u524d\u7528\u6237\u6240\u5c5e\u90e8\u95e8Id\u5e26\u4e0a\uff0c\u8fdb\u884c\u7ec4\u7ec7\u67b6\u6784\u96c6\u5408\u8fc7\u6ee4\u67e5\u8be2\u3002\u6bcf\u4e2a\u7528\u6237\u7684\u7ec4\u7ec7\u67b6\u6784\u96c6\u5408\u548c\u7528\u6237\u6240\u5904\u90e8\u95e8\u7ea7\u522b\u6709\u5173\uff0c\u6bd4\u5982\u4e0a\u7ea7\u3001\u4e0b\u7ea7\u3002\u8d85\u7ba1\u4e0d\u53d7\u4efb\u4f55\u6743\u9650\u63a7\u5236\u3002"}),"\n",(0,i.jsx)(n.p,{children:"\u5177\u4f53\u8c03\u7528\u5b9e\u5728\u6570\u636e\u5e93AOP\u521d\u59cb\u5316\u65f6 SqlSugarFilter.SetOrgEntityFilter(db); \uff0c\u8fd9\u6837\u5168\u5c40\u67e5\u8be2\u65f6\u4f1a\u81ea\u52a8\u5e26\u4e0a\u90e8\u95e8Id\u8fdb\u884c\u8fc7\u6ee4\u3002\u5177\u4f53\u5b9e\u73b0\u7c7b SqlSugarFilter.cs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-csharp",children:'    /// <summary>\n    /// \u914d\u7f6e\u7528\u6237\u673a\u6784\u96c6\u5408\u8fc7\u6ee4\u5668\n    /// </summary>\n    public static void SetOrgEntityFilter(SqlSugarScopeProvider db)\n    {\n        // \u82e5\u4ec5\u672c\u4eba\u6570\u636e\uff0c\u5219\u76f4\u63a5\u8fd4\u56de\n        if (SetDataScopeFilter(db) == (int)DataScopeEnum.Self) return;\n\n        var userId = App.User?.FindFirst(ClaimConst.UserId)?.Value;\n        if (string.IsNullOrWhiteSpace(userId)) return;\n\n        // \u914d\u7f6e\u7528\u6237\u673a\u6784\u96c6\u5408\u7f13\u5b58\n        var cacheKey = $"db:{db.CurrentConnectionConfig.ConfigId}:orgList:{userId}";\n        var orgFilter = _cache.Get<ConcurrentDictionary<Type, LambdaExpression>>(cacheKey);\n        if (orgFilter == null)\n        {\n            // \u83b7\u53d6\u7528\u6237\u6240\u5c5e\u673a\u6784\uff0c\u4fdd\u8bc1\u540c\u4e00\u4f5c\u7528\u57df\n            var orgIds = new List<long>();\n            Scoped.Create((factory, scope) =>\n            {\n                var services = scope.ServiceProvider;\n                orgIds = services.GetService<SysOrgService>().GetUserOrgIdList().GetAwaiter().GetResult();\n            });\n            if (orgIds == null || orgIds.Count == 0) return;\n\n            // \u83b7\u53d6\u4e1a\u52a1\u5b9e\u4f53\u6570\u636e\u8868\n            var entityTypes = App.EffectiveTypes.Where(u => !u.IsInterface && !u.IsAbstract && u.IsClass\n                && u.IsSubclassOf(typeof(EntityBaseData)));\n            if (!entityTypes.Any()) return;\n\n            orgFilter = new ConcurrentDictionary<Type, LambdaExpression>();\n            foreach (var entityType in entityTypes)\n            {\n                // \u6392\u9664\u975e\u5f53\u524d\u6570\u636e\u5e93\u5b9e\u4f53\n                var tAtt = entityType.GetCustomAttribute<TenantAttribute>();\n                if ((tAtt != null && db.CurrentConnectionConfig.ConfigId.ToString() != tAtt.configId.ToString()))\n                    continue;\n\n                var lambda = DynamicExpressionParser.ParseLambda(new[] {\n                    Expression.Parameter(entityType, "u") }, typeof(bool), $"@0.Contains(u.{nameof(EntityBaseData.CreateOrgId)}??{default(long)})", orgIds);\n                db.QueryFilter.AddTableFilter(entityType, lambda);\n                orgFilter.TryAdd(entityType, lambda);\n            }\n            _cache.Add(cacheKey, orgFilter);\n        }\n        else\n        {\n            foreach (var filter in orgFilter)\n                db.QueryFilter.AddTableFilter(filter.Key, filter.Value);\n        }\n    }\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u652f\u6301\u81ea\u5b9a\u4e49\u8fc7\u6ee4\u6761\u4ef6"})," \u6bd4\u5982\u5b9a\u4e49\u67d0\u5b9e\u4f53\u4e0d\u4ec5\u6309\u7167\u90e8\u95e8Id\u8fdb\u884c\u8fc7\u6ee4\uff0c\u8fd8\u53ef\u4ee5\u81ea\u884c\u5b9a\u4e49\u8fc7\u6ee4\u6761\u4ef6\uff0c\u6bd4\u5982\u6309\u7167\u540d\u79f0\u3001\u7f16\u7801\u8fdb\u884c\u8fc7\u6ee4\u7b49\u3002\u5177\u4f53\u5b9e\u73b0\u7c7b SqlSugarFilter.cs"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-csharp",children:'    /// <summary>\n    /// \u914d\u7f6e\u81ea\u5b9a\u4e49\u8fc7\u6ee4\u5668\n    /// </summary>\n    public static void SetCustomEntityFilter(SqlSugarScopeProvider db)\n    {\n        // \u914d\u7f6e\u81ea\u5b9a\u4e49\u7f13\u5b58\n        var userId = App.User?.FindFirst(ClaimConst.UserId)?.Value;\n        var cacheKey = $"db:{db.CurrentConnectionConfig.ConfigId}:custom:{userId}";\n        var tableFilterItemList = _cache.Get<List<TableFilterItem<object>>>(cacheKey);\n        if (tableFilterItemList == null)\n        {\n            // \u83b7\u53d6\u81ea\u5b9a\u4e49\u5b9e\u4f53\u8fc7\u6ee4\u5668\n            var entityFilterTypes = App.EffectiveTypes.Where(u => !u.IsInterface && !u.IsAbstract && u.IsClass\n                && u.GetInterfaces().Any(i => i.HasImplementedRawGeneric(typeof(IEntityFilter))));\n            if (!entityFilterTypes.Any()) return;\n\n            var tableFilterItems = new List<TableFilterItem<object>>();\n            foreach (var entityFilter in entityFilterTypes)\n            {\n                var instance = Activator.CreateInstance(entityFilter);\n                var entityFilterMethod = entityFilter.GetMethod("AddEntityFilter");\n                var entityFilters = ((IList)entityFilterMethod?.Invoke(instance, null))?.Cast<object>();\n                if (entityFilters == null) continue;\n\n                foreach (var u in entityFilters)\n                {\n                    var tableFilterItem = (TableFilterItem<object>)u;\n                    var entityType = tableFilterItem.GetType().GetProperty("type", BindingFlags.Instance | BindingFlags.NonPublic).GetValue(tableFilterItem, null) as Type;\n                    // \u6392\u9664\u975e\u5f53\u524d\u6570\u636e\u5e93\u5b9e\u4f53\n                    var tAtt = entityType.GetCustomAttribute<TenantAttribute>();\n                    if ((tAtt != null && db.CurrentConnectionConfig.ConfigId.ToString() != tAtt.configId.ToString()) ||\n                        (tAtt == null && db.CurrentConnectionConfig.ConfigId.ToString() != SqlSugarConst.MainConfigId))\n                        continue;\n\n                    tableFilterItems.Add(tableFilterItem);\n                    db.QueryFilter.Add(tableFilterItem);\n                }\n            }\n            _cache.Add(cacheKey, tableFilterItems);\n        }\n        else\n        {\n            tableFilterItemList.ForEach(u =>\n            {\n                db.QueryFilter.Add(u);\n            });\n        }\n    }\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u5e94\u7528\u5c42\u53ea\u9700\u8981\u5b9e\u73b0\u7ee7\u627f\u6570\u636e\u6743\u9650\u63a5\u53e3 ",(0,i.jsx)(n.code,{children:"IEntityFilter"})," \u5373\u53ef\uff0c\u793a\u4f8b\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-csharp",children:'/// <summary>\n/// \u81ea\u5b9a\u4e49\u4e1a\u52a1\u5b9e\u4f53\u8fc7\u6ee4\u5668\u793a\u4f8b\n/// </summary>\npublic class TestEntityFilter : IEntityFilter\n{\n    public IEnumerable<TableFilterItem<object>> AddEntityFilter()\n    {\n        // \u6784\u9020\u81ea\u5b9a\u4e49\u6761\u4ef6\u7684\u8fc7\u6ee4\u5668\n        Expression<Func<SysUser, bool>> dynamicExpression = u => u.Remark.Contains("xxx");\n        var tableFilterItem = new TableFilterItem<object>(typeof(SysUser), dynamicExpression);\n\n        return new[]\n        {\n            tableFilterItem\n        };\n    }\n}\n'})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);