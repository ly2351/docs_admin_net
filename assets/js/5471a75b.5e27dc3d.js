"use strict";(self.webpackChunkdocs_admin_net=self.webpackChunkdocs_admin_net||[]).push([[3489],{4641:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>p,contentTitle:()=>c,default:()=>d,frontMatter:()=>s,metadata:()=>r,toc:()=>m});const r=JSON.parse('{"id":"backend/sm","title":"13. \u56fd\u5bc6\u4fe1\u521b","description":"\u5b8c\u7f8e\u9002\u914d\u56fd\u4ea7\u5316\u8f6f\u786c\u4ef6\u73af\u5883\uff0c\u652f\u6301\u56fd\u4ea7\u4e2d\u95f4\u4ef6\u3001\u56fd\u4ea7\u6570\u636e\u5e93\u3001\u9e92\u9e9f\u64cd\u4f5c\u7cfb\u7edf\u3001Windows\u3001Linux\u90e8\u7f72\u4f7f\u7528\uff1b\u96c6\u6210\u56fd\u5bc6\u52a0\u89e3\u5bc6\u63d2\u4ef6\uff0c\u4f7f\u7528SM2\u3001SM3\u3001SM4\u7b49\u56fd\u5bc6\u7b97\u6cd5\u8fdb\u884c\u7b7e\u540d\u3001\u6570\u636e\u5b8c\u6574\u6027\u4fdd\u62a4\uff1b\u8f6f\u4ef6\u5c42\u9762\u5168\u9762\u9075\u5faa\u7b49\u7ea7\u4fdd\u62a4\u6d4b\u8bc4\u8981\u6c42\uff0c\u5b8c\u5168\u7b26\u5408\u7b49\u4fdd\u3001\u5bc6\u8bc4\u8981\u6c42\u3002","source":"@site/docs/backend/sm.md","sourceDirName":"backend","slug":"/backend/sm","permalink":"/docs_admin_net/docs/backend/sm","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/backend/sm.md","tags":[],"version":"current","sidebarPosition":13,"frontMatter":{"sidebar_position":13},"sidebar":"tutorialSidebar","previous":{"title":"12. \u63a5\u53e3\u9650\u6d41","permalink":"/docs_admin_net/docs/backend/limit"},"next":{"title":"14. \u56fe\u7247\u538b\u7f29","permalink":"/docs_admin_net/docs/backend/imagecompress"}}');var i=t(3420),a=t(5404);const s={sidebar_position:13},c="13. \u56fd\u5bc6\u4fe1\u521b",p={},m=[];function y(n){const e={admonition:"admonition",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,a.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"13-\u56fd\u5bc6\u4fe1\u521b",children:"13. \u56fd\u5bc6\u4fe1\u521b"})}),"\n",(0,i.jsx)(e.admonition,{title:"\u63d0\u793a",type:"tip",children:(0,i.jsx)(e.p,{children:"\u5b8c\u7f8e\u9002\u914d\u56fd\u4ea7\u5316\u8f6f\u786c\u4ef6\u73af\u5883\uff0c\u652f\u6301\u56fd\u4ea7\u4e2d\u95f4\u4ef6\u3001\u56fd\u4ea7\u6570\u636e\u5e93\u3001\u9e92\u9e9f\u64cd\u4f5c\u7cfb\u7edf\u3001Windows\u3001Linux\u90e8\u7f72\u4f7f\u7528\uff1b\u96c6\u6210\u56fd\u5bc6\u52a0\u89e3\u5bc6\u63d2\u4ef6\uff0c\u4f7f\u7528SM2\u3001SM3\u3001SM4\u7b49\u56fd\u5bc6\u7b97\u6cd5\u8fdb\u884c\u7b7e\u540d\u3001\u6570\u636e\u5b8c\u6574\u6027\u4fdd\u62a4\uff1b\u8f6f\u4ef6\u5c42\u9762\u5168\u9762\u9075\u5faa\u7b49\u7ea7\u4fdd\u62a4\u6d4b\u8bc4\u8981\u6c42\uff0c\u5b8c\u5168\u7b26\u5408\u7b49\u4fdd\u3001\u5bc6\u8bc4\u8981\u6c42\u3002"})}),"\n",(0,i.jsxs)(e.admonition,{title:"\u63d0\u793a",type:"tip",children:[(0,i.jsx)(e.p,{children:"Admin.NET \u5bc6\u7801\u76f8\u5173\u9ed8\u8ba4\u5f00\u542fSM2\u56fd\u5bc6\u52a0\u5bc6\u4f20\u8f93\u548c\u5b58\u50a8\u3002MD5\u3001SM2\u3001SM4 \u4efb\u610f\u5207\u6362\u3002"}),(0,i.jsx)(e.p,{children:"\u6709\u8ba1\u5212\u6362\u6389 MD5 \u5bc6\u7801\u52a0\u5bc6\uff0c\u91c7\u7528 PBKDF2 \u52a0\u5bc6\u3002"}),(0,i.jsx)(e.p,{children:'var pbkdf2Hash = PBKDF2Encryption.Encrypt("Admin.NET"); // \u52a0\u5bc6'}),(0,i.jsx)(e.p,{children:'PBKDF2Encryption.Compare("Admin.NET", pbkdf2Hash); // \u6bd4\u8f83'})]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-json",children:'  "Cryptogram": {\n    "StrongPassword": false, // \u662f\u5426\u5f00\u542f\u5bc6\u7801\u5f3a\u5ea6\u9a8c\u8bc1\n    "PasswordStrengthValidation": "(?=^.{6,16}$)(?=.*\\\\d)(?=.*\\\\W+)(?=.*[A-Z])(?=.*[a-z])(?!.*\\\\n).*$", // \u5bc6\u7801\u5f3a\u5ea6\u9a8c\u8bc1\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5fc5\u987b\u987b\u5305\u542b\u5927\u5c0f\u5199\u5b57\u6bcd\u3001\u6570\u5b57\u548c\u7279\u6b8a\u5b57\u7b26\u7684\u7ec4\u5408\uff0c\u957f\u5ea6\u57286-16\u4e4b\u95f4\n    "PasswordStrengthValidationMsg": "\u5bc6\u7801\u5fc5\u987b\u5305\u542b\u5927\u5c0f\u5199\u5b57\u6bcd\u3001\u6570\u5b57\u548c\u7279\u6b8a\u5b57\u7b26\u7684\u7ec4\u5408\uff0c\u957f\u5ea6\u57286-16\u4e4b\u95f4", // \u5bc6\u7801\u5f3a\u5ea6\u9a8c\u8bc1\u6d88\u606f\u63d0\u793a\n    "CryptoType": "SM2", // \u5bc6\u7801\u52a0\u5bc6\u7b97\u6cd5\uff1aMD5\u3001SM2\u3001SM4\n    "PublicKey": "0484C7466D950E120E5ECE5DD85D0C90EAA85081A3A2BD7C57AE6DC822EFCCBD66620C67B0103FC8DD280E36C3B282977B722AAEC3C56518EDCEBAFB72C5A05312", // \u516c\u94a5\n    "PrivateKey": "8EDB615B1D48B8BE188FC0F18EC08A41DF50EA731FA28BF409E6552809E3A111" // \u79c1\u94a5\n  }\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u7cfb\u7edf\u5df2\u7ecf\u5c01\u88c5 SM2\u3001SM3\u3001SM4 \u56fd\u5bc6\u7b97\u6cd5\uff0c\u5177\u4f53\u8c03\u7528\u65b9\u6cd5\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(e.p,{children:"1\u3001GMUtil.SM2Encrypt() \u8fdb\u884cSM2\u52a0\u5bc6"}),"\n",(0,i.jsx)(e.p,{children:"2\u3001GMUtil.SM2Decrypt() \u8fdb\u884cSM2\u89e3\u5bc6"}),"\n",(0,i.jsx)(e.p,{children:"3\u3001GMUtil.SM4EncryptECB() \u8fdb\u884cSM4\u52a0\u5bc6\uff08ECB\uff09"}),"\n",(0,i.jsx)(e.p,{children:"4\u3001GMUtil.SM4DecryptECB() \u8fdb\u884cSM4\u89e3\u5bc6\uff08ECB\uff09"}),"\n",(0,i.jsx)(e.p,{children:"5\u3001GMUtil.SM4EncryptCBC() \u8fdb\u884cSM4\u52a0\u5bc6\uff08CBC\uff09"}),"\n",(0,i.jsx)(e.p,{children:"6\u3001GMUtil.SM4DecryptCBC() \u8fdb\u884cSM4\u89e3\u5bc6\uff08CBC\uff09"}),"\n",(0,i.jsx)(e.p,{children:"\u5177\u4f53\u5b9e\u73b0\u7c7b Admin.NET.Core/Util/GM/GMUtil.cs"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'/// <summary>\n/// GM\u5de5\u5177\u7c7b\n/// </summary>\npublic class GMUtil\n{\n    /// <summary>\n    /// SM2\u52a0\u5bc6\n    /// </summary>\n    /// <param name="publicKeyHex"></param>\n    /// <param name="data_string"></param>\n    /// <returns></returns>\n    public static string SM2Encrypt(string publicKeyHex, string data_string)\n    {\n        // \u5982\u679c\u662f130\u4f4d\u516c\u94a5\uff0c.NET\u4f7f\u7528\u7684\u8bdd\uff0c\u628a\u5f00\u5934\u768404\u622a\u53d6\u6389\n        if (publicKeyHex.Length == 130)\n        {\n            publicKeyHex = publicKeyHex.Substring(2, 128);\n        }\n        // \u516c\u94a5X\uff0c\u524d64\u4f4d\n        string x = publicKeyHex.Substring(0, 64);\n        // \u516c\u94a5Y\uff0c\u540e64\u4f4d\n        string y = publicKeyHex.Substring(64);\n        // \u83b7\u53d6\u516c\u94a5\u5bf9\u8c61\n        AsymmetricKeyParameter publicKey1 = GM.GetPublickeyFromXY(new BigInteger(x, 16), new BigInteger(y, 16));\n        // Sm2Encrypt: C1C3C2\n        // Sm2EncryptOld: C1C2C3\n        byte[] digestByte = GM.Sm2Encrypt(Encoding.UTF8.GetBytes(data_string), publicKey1);\n        string strSM2 = Hex.ToHexString(digestByte);\n        return strSM2;\n    }\n\n    /// <summary>\n    /// SM2\u89e3\u5bc6\n    /// </summary>\n    /// <param name="privateKey_string"></param>\n    /// <param name="encryptedData_string"></param>\n    /// <returns></returns>\n    public static string SM2Decrypt(string privateKey_string, string encryptedData_string)\n    {\n        if (!encryptedData_string.StartsWith("04"))\n            encryptedData_string = "04" + encryptedData_string;\n        BigInteger d = new(privateKey_string, 16);\n        // \u5148\u62ff\u5230\u79c1\u94a5\u5bf9\u8c61\uff0c\u7528ECPrivateKeyParameters \u6216 AsymmetricKeyParameter \u90fd\u53ef\u4ee5\n        // ECPrivateKeyParameters bcecPrivateKey = GmUtil.GetPrivatekeyFromD(d);\n        AsymmetricKeyParameter bcecPrivateKey = GM.GetPrivatekeyFromD(d);\n        byte[] byToDecrypt = Hex.Decode(encryptedData_string);\n        byte[] byDecrypted = GM.Sm2Decrypt(byToDecrypt, bcecPrivateKey);\n        string strDecrypted = Encoding.UTF8.GetString(byDecrypted);\n        return strDecrypted;\n    }\n\n    /// <summary>\n    /// SM4\u52a0\u5bc6\uff08ECB\uff09\n    /// </summary>\n    /// <param name="key_string"></param>\n    /// <param name="plainText"></param>\n    /// <returns></returns>\n    public static string SM4EncryptECB(string key_string, string plainText)\n    {\n        byte[] key = Hex.Decode(key_string);\n        byte[] bs = GM.Sm4EncryptECB(key, Encoding.UTF8.GetBytes(plainText), GM.SM4_ECB_PKCS7PADDING);//NoPadding \u7684\u60c5\u51b5\u4e0b\u9700\u8981\u6821\u9a8c\u6570\u636e\u957f\u5ea6\u662f16\u7684\u500d\u6570. \u4f7f\u7528 HandleSm4Padding \u5904\u7406\n        return Hex.ToHexString(bs);\n    }\n\n    /// <summary>\n    /// SM4\u89e3\u5bc6\uff08ECB\uff09\n    /// </summary>\n    /// <param name="key_string"></param>\n    /// <param name="cipherText"></param>\n    /// <returns></returns>\n    public static string SM4DecryptECB(string key_string, string cipherText)\n    {\n        byte[] key = Hex.Decode(key_string);\n        byte[] bs = GM.Sm4DecryptECB(key, Hex.Decode(cipherText), GM.SM4_ECB_PKCS7PADDING);\n        return Encoding.UTF8.GetString(bs);\n    }\n\n    /// <summary>\n    /// SM4\u52a0\u5bc6\uff08CBC\uff09\n    /// </summary>\n    /// <param name="key_string"></param>\n    /// <param name="iv_string"></param>\n    /// <param name="plainText"></param>\n    /// <returns></returns>\n    public static string SM4EncryptCBC(string key_string, string iv_string, string plainText)\n    {\n        byte[] key = Hex.Decode(key_string);\n        byte[] iv = Hex.Decode(iv_string);\n        byte[] bs = GM.Sm4EncryptCBC(key, Encoding.UTF8.GetBytes(plainText), iv, GM.SM4_CBC_PKCS7PADDING);\n        return Hex.ToHexString(bs);\n    }\n\n    /// <summary>\n    /// SM4\u89e3\u5bc6\uff08CBC\uff09\n    /// </summary>\n    /// <param name="key_string"></param>\n    /// <param name="iv_string"></param>\n    /// <param name="cipherText"></param>\n    /// <returns></returns>\n    public static string SM4DecryptCBC(string key_string, string iv_string, string cipherText)\n    {\n        byte[] key = Hex.Decode(key_string);\n        byte[] iv = Hex.Decode(iv_string);\n        byte[] bs = GM.Sm4DecryptCBC(key, Hex.Decode(cipherText), iv, GM.SM4_CBC_PKCS7PADDING);\n        return Encoding.UTF8.GetString(bs);\n    }\n\n    /// <summary>\n    /// \u8865\u8db3 16 \u8fdb\u5236\u5b57\u7b26\u4e32\u7684 0 \u5b57\u7b26\uff0c\u8fd4\u56de\u4e0d\u5e26 0x \u768416\u8fdb\u5236\u5b57\u7b26\u4e32\n    /// </summary>\n    /// <param name="input"></param>\n    /// <param name="mode">1\u8868\u793a\u52a0\u5bc6\uff0c0\u8868\u793a\u89e3\u5bc6</param>\n    /// <returns></returns>\n    private static byte[] HandleSm4Padding(byte[] input, int mode)\n    {\n        if (input == null)\n        {\n            return null;\n        }\n        byte[] ret = (byte[])null;\n        if (mode == 1)\n        {\n            int p = 16 - input.Length % 16;\n            ret = new byte[input.Length + p];\n            Array.Copy(input, 0, ret, 0, input.Length);\n            for (int i = 0; i < p; i++)\n            {\n                ret[input.Length + i] = (byte)p;\n            }\n        }\n        else\n        {\n            int p = input[input.Length - 1];\n            ret = new byte[input.Length - p];\n            Array.Copy(input, 0, ret, 0, input.Length - p);\n        }\n        return ret;\n    }\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u7cfb\u7edf\u5185\u7f6e\u4e86\u83b7\u53d6\u56fd\u5bc6\u516c\u94a5\u79c1\u94a5\u5bf9\u5b9e\u73b0\u548c\u63a5\u53e3 Admin.NET.Core/Service/Common/SysCommonService.cs\uff0c\u4fdd\u8bc1\u516c\u5319\u524d\u540e\u7aef\u4e00\u81f4\u624d\u884c\u3002\u63a5\u53e3\u5730\u5740 /api/sysCommon/smKeyPair"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'    /// <summary>\n    /// \u83b7\u53d6\u56fd\u5bc6\u516c\u94a5\u79c1\u94a5\u5bf9 \ud83c\udfc6\n    /// </summary>\n    /// <returns></returns>\n    [DisplayName("\u83b7\u53d6\u56fd\u5bc6\u516c\u94a5\u79c1\u94a5\u5bf9")]\n    public SmKeyPairOutput GetSmKeyPair()\n    {\n        var kp = GM.GenerateKeyPair();\n        var privateKey = Hex.ToHexString(((ECPrivateKeyParameters)kp.Private).D.ToByteArray()).ToUpper();\n        var publicKey = Hex.ToHexString(((ECPublicKeyParameters)kp.Public).Q.GetEncoded()).ToUpper();\n\n        return new SmKeyPairOutput\n        {\n            PrivateKey = privateKey,\n            PublicKey = publicKey,\n        };\n    }\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u524d\u7aef\u516c\u5319\u8def\u5f84\u5728 Web/.env\u3002"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-env",children:'# port \u7aef\u53e3\u53f7\nVITE_PORT = 8888\n\n# open \u8fd0\u884c npm run dev \u65f6\u81ea\u52a8\u6253\u5f00\u6d4f\u89c8\u5668\nVITE_OPEN = false\n\n# \u6253\u5305\u662f\u5426\u5f00\u542f cdn\uff08\u6e90\u6587\u4ef6 utils/build.ts\uff09\uff0c\u53ef\u81ea\u884c\u4fee\u6539\nVITE_OPEN_CDN = false\n\n# public path \u914d\u7f6e\u7ebf\u4e0a\u73af\u5883\u8def\u5f84\uff08\u6253\u5305\uff09\u3001\u672c\u5730\u901a\u8fc7 http-server \u8bbf\u95ee\u65f6\uff0c\u8bf7\u7f6e\u7a7a\u5373\u53ef\nVITE_PUBLIC_PATH =\n\n# SM\u516c\u94a5\nVITE_SM_PUBLIC_KEY = "0484C7466D950E120E5ECE5DD85D0C90EAA85081A3A2BD7C57AE6DC822EFCCBD66620C67B0103FC8DD280E36C3B282977B722AAEC3C56518EDCEBAFB72C5A05312"\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u524d\u7aef\u5bc6\u7801\u52a0\u5bc6\u4f20\u8f93\u5e94\u7528\uff1aWeb/src/views/login/component/account.vue"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-vue",children:"   // SM2\u52a0\u5bc6\u5bc6\u7801\n   // const keys = SM2.generateKeyPair(); // \u751f\u6210\u5bc6\u5319\u5bf9\n   const publicKey = window.__env__.VITE_SM_PUBLIC_KEY;\n   const password = sm2.doEncrypt(state.ruleForm.password, publicKey, 1);\n"})})]})}function d(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(y,{...n})}):y(n)}},5404:(n,e,t)=>{t.d(e,{R:()=>s,x:()=>c});var r=t(6672);const i={},a=r.createContext(i);function s(n){const e=r.useContext(a);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:s(n.components),r.createElement(a.Provider,{value:e},n.children)}}}]);