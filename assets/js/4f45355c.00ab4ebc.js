"use strict";(self.webpackChunkdocs_admin_net=self.webpackChunkdocs_admin_net||[]).push([[1796],{612:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>t,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"backend/sms","title":"15. \u77ed\u4fe1\u53d1\u9001","description":"Admin.NET \u91c7\u7528 AlibabaCloud.SDK.Dysmsapi20170525 \u963f\u91cc\u4e91\u77ed\u4fe1\u7684SDK\u7ec4\u4ef6\u3002\u8bbf\u95ee\u5bc6\u94a5\uff08AccessKey\uff09\u53ca\u8bbf\u95ee Id \u7684\u83b7\u53d6\u8bf7\u53c2\u8003\u963f\u91cc\u4e91\u77ed\u4fe1jicheng","source":"@site/docs/backend/sms.md","sourceDirName":"backend","slug":"/backend/sms","permalink":"/docs_admin_net/docs/backend/sms","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/backend/sms.md","tags":[],"version":"current","sidebarPosition":15,"frontMatter":{"sidebar_position":15},"sidebar":"tutorialSidebar","previous":{"title":"14. \u56fe\u7247\u538b\u7f29","permalink":"/docs_admin_net/docs/backend/imagecompress"},"next":{"title":"16. \u5fae\u4fe1\u5bf9\u63a5","permalink":"/docs_admin_net/docs/backend/weixin"}}');var r=s(3420),a=s(5404);const t={sidebar_position:15},o="15. \u77ed\u4fe1\u53d1\u9001",c={},d=[];function m(e){const n={admonition:"admonition",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"15-\u77ed\u4fe1\u53d1\u9001",children:"15. \u77ed\u4fe1\u53d1\u9001"})}),"\n",(0,r.jsx)(n.admonition,{title:"\u63d0\u793a",type:"tip",children:(0,r.jsx)(n.p,{children:"Admin.NET \u91c7\u7528 AlibabaCloud.SDK.Dysmsapi20170525 \u963f\u91cc\u4e91\u77ed\u4fe1\u7684SDK\u7ec4\u4ef6\u3002\u8bbf\u95ee\u5bc6\u94a5\uff08AccessKey\uff09\u53ca\u8bbf\u95ee Id \u7684\u83b7\u53d6\u8bf7\u53c2\u8003\u963f\u91cc\u4e91\u77ed\u4fe1jicheng"})}),"\n",(0,r.jsx)(n.p,{children:"\u77ed\u4fe1\u914d\u7f6e\u6587\u4ef6 Configuration/SMS.json\uff0c\u96c6\u6210\u6559\u7a0b \u963f\u91cc\u4e91\u96c6\u6210SDK"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "$schema": "https://gitee.com/dotnetchina/Furion/raw/v4/schemas/v4/furion-schema.json",\n\n  "SMS": {\n    "Aliyun": {\n      "AccessKeyId": "",\n      "AccessKeySecret": "",\n      "SignName": "AdminNET\u5e73\u53f0", // \u77ed\u4fe1\u7b7e\u540d\n      "TemplateCode": "" // \u77ed\u4fe1\u6a21\u677f\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u7cfb\u7edf\u7ee7\u627f\u5b9e\u73b0\u7684\u5177\u4f53\u7c7b\u6587\u4ef6 Admin.NET.Core/Service/Message/SysSmsService.cs"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'using AlibabaCloud.SDK.Dysmsapi20170525.Models;\n\nnamespace Admin.NET.Core.Service;\n\n/// <summary>\n/// \u7cfb\u7edf\u77ed\u4fe1\u670d\u52a1 \ud83e\udde9\n/// </summary>\n[AllowAnonymous]\n[ApiDescriptionSettings(Order = 150)]\npublic class SysSmsService : IDynamicApiController, ITransient\n{\n    private readonly SMSOptions _smsOptions;\n    private readonly SysCacheService _sysCacheService;\n\n    public SysSmsService(IOptions<SMSOptions> smsOptions,\n        SysCacheService sysCacheService)\n    {\n        _smsOptions = smsOptions.Value;\n        _sysCacheService = sysCacheService;\n    }\n\n    /// <summary>\n    /// \u53d1\u9001\u77ed\u4fe1 \ud83d\udce8\n    /// </summary>\n    /// <param name="phoneNumber"></param>\n    /// <returns></returns>\n    [AllowAnonymous]\n    [DisplayName("\u53d1\u9001\u77ed\u4fe1")]\n    public async Task SendSms([Required] string phoneNumber)\n    {\n        if (!phoneNumber.TryValidate(ValidationTypes.PhoneNumber).IsValid)\n            throw Oops.Oh("\u8bf7\u6b63\u786e\u586b\u5199\u624b\u673a\u53f7\u7801");\n\n        // \u751f\u6210\u968f\u673a\u9a8c\u8bc1\u7801\n        var random = new Random();\n        var verifyCode = random.Next(100000, 999999);\n\n        var templateParam = Clay.Object(new\n        {\n            code = verifyCode\n        });\n\n        var client = CreateClient();\n        var sendSmsRequest = new SendSmsRequest\n        {\n            PhoneNumbers = phoneNumber, // \u5f85\u53d1\u9001\u624b\u673a\u53f7, \u591a\u4e2a\u4ee5\u9017\u53f7\u5206\u9694\n            SignName = _smsOptions.Aliyun.SignName, // \u77ed\u4fe1\u7b7e\u540d\n            TemplateCode = _smsOptions.Aliyun.TemplateCode, // \u77ed\u4fe1\u6a21\u677f\n            TemplateParam = templateParam.ToString(), // \u6a21\u677f\u4e2d\u7684\u53d8\u91cf\u66ff\u6362JSON\u4e32\n            OutId = YitIdHelper.NextId().ToString()\n        };\n        var sendSmsResponse = client.SendSms(sendSmsRequest);\n        if (sendSmsResponse.Body.Code == "OK" && sendSmsResponse.Body.Message == "OK")\n        {\n            // var bizId = sendSmsResponse.Body.BizId;\n            _sysCacheService.Set($"{CacheConst.KeyPhoneVerCode}{phoneNumber}", verifyCode, TimeSpan.FromSeconds(60));\n        }\n        else\n        {\n            throw Oops.Oh($"\u77ed\u4fe1\u53d1\u9001\u5931\u8d25\uff1a{sendSmsResponse.Body.Code}-{sendSmsResponse.Body.Message}");\n        }\n\n        await Task.CompletedTask;\n    }\n\n    /// <summary>\n    /// \u963f\u91cc\u4e91\u77ed\u4fe1\u914d\u7f6e\n    /// </summary>\n    /// <returns></returns>\n    private AlibabaCloud.SDK.Dysmsapi20170525.Client CreateClient()\n    {\n        var config = new AlibabaCloud.OpenApiClient.Models.Config\n        {\n            AccessKeyId = _smsOptions.Aliyun.AccessKeyId,\n            AccessKeySecret = _smsOptions.Aliyun.AccessKeySecret,\n            Endpoint = "dysmsapi.aliyuncs.com"\n        };\n        return new AlibabaCloud.SDK.Dysmsapi20170525.Client(config);\n    }\n}\n'})}),"\n",(0,r.jsx)(n.admonition,{title:"\u63d0\u793a",type:"tip",children:(0,r.jsx)(n.p,{children:"\u6bcf\u6b21\u53d1\u9001\u77ed\u4fe1\u65f6\u7cfb\u7edf\u4f1a\u81ea\u52a8\u7f13\u5b58\u624b\u673a\u9a8c\u8bc1\u7801\uff0c\u9ed8\u8ba4 60 \u79d2\u6709\u6548\u671f\uff0c\u4f9b\u624b\u673a\u53f7\u767b\u5f55\u9a8c\u8bc1\u7b49\u573a\u666f\u6a21\u5f0f\u3002\u76f4\u63a5\u4f7f\u7528\u65b9\u6cd5 SendSms \u6307\u5b9a\u624b\u673a\u53f7\u5373\u53ef\u53d1\u9001\u77ed\u4fe1\u3002"})}),"\n",(0,r.jsx)(n.p,{children:"\u4e0b\u9762\u662f\u7cfb\u7edf\u81ea\u5e26\u7684\u624b\u673a\u53f7\u767b\u5f55\u573a\u666f\u6a21\u5f0f\uff0c\u5b9e\u73b0\u7c7b\u4e3a Admin.NET.Core/Service/Auth/SysAuthService.cs\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'    /// <summary>\n    /// \u624b\u673a\u53f7\u767b\u5f55 \ud83d\udd16\n    /// </summary>\n    /// <param name="input"></param>\n    /// <returns></returns>\n    [AllowAnonymous]\n    [DisplayName("\u624b\u673a\u53f7\u767b\u5f55")]\n    public virtual async Task<LoginOutput> LoginPhone([Required] LoginPhoneInput input)\n    {\n        var verifyCode = _sysCacheService.Get<string>($"{CacheConst.KeyPhoneVerCode}{input.Phone}");\n        if (string.IsNullOrWhiteSpace(verifyCode))\n            throw Oops.Oh("\u9a8c\u8bc1\u7801\u4e0d\u5b58\u5728\u6216\u5df2\u5931\u6548\uff0c\u8bf7\u91cd\u65b0\u83b7\u53d6\uff01");\n        if (verifyCode != input.Code)\n            throw Oops.Oh("\u9a8c\u8bc1\u7801\u9519\u8bef\uff01");\n\n        // \u8d26\u53f7\u662f\u5426\u5b58\u5728\n        var user = await _sysUserRep.AsQueryable().Includes(t => t.SysOrg).ClearFilter().FirstAsync(u => u.Phone.Equals(input.Phone));\n        _ = user ?? throw Oops.Oh(ErrorCodeEnum.D0009);\n\n        return await CreateToken(user);\n    }\n'})})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(m,{...e})}):m(e)}},5404:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>o});var i=s(6672);const r={},a=i.createContext(r);function t(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);